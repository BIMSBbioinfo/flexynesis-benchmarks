---
title: "Collate results make summary benchmark figures"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: united
params:
  workdir: '' 
author: Bora Uyar
---

`r date()`

```{r setup, include=FALSE}
workdir = params$workdir 
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, fig.width = 10, 
                      fig.height = 8)
knitr::opts_knit$set(root.dir = workdir)
library(data.table)
library(ggplot2)
library(ggpubr)
library(pbapply)
library(DT)
library(knitr)
ggplot2::theme_set(ggpubr::theme_pubclean())
```

```{r read_files}
files <- dir(workdir, "stats.csv$", recursive = T)
stats <- do.call(rbind, pbapply::pblapply(files[!grepl('baseline', files)], function(x) {
  dt <- data.table::fread(file.path(workdir, x))
  dt$prefix <- gsub(".stats.csv", '', basename(x))
  return(dt)
}))

# stats from off-the-shelf methods
baseline_stats <- do.call(rbind, pbapply::pblapply(files[grepl('baseline', files)], function(x) {
  dt <- data.table::fread(file.path(workdir, x))
  dt$prefix <- gsub(".baseline.stats.csv", '', basename(x))
  return(dt)
}))
colnames(baseline_stats)[1] <- 'tool'
# combine with analysis table
analysis_table <- data.table::fread(file.path(workdir, 'analysis_table.csv'))[,-1]

# concatenate tool-specific options into single string 
analysis_table$tool <- apply(analysis_table, 1, function(x) {
  gsub(" ", "", paste0(x['tool'],
         ";fusion:",x['fusion'],";hpo:",x['hpo_iter'],
         ";earlystop:",x['early_stop_patience'],
         ";lossweights:",x['use_loss_weighting']))
})

# concatenate stats with baseline-stats
stats$tool <- analysis_table[match(stats$prefix, prefix)]$tool

setcolorder(stats, colnames(baseline_stats))
stats <- rbind(stats, baseline_stats)

analysis_table <- subset(analysis_table, select = setdiff(colnames(analysis_table), c('tool', 'fusion', 'hpo_iter', 'early_stop_patience', 'use_loss_weighting')))
stats <- merge.data.table(analysis_table, stats, by = 'prefix')

# split stats by dataset/task
stats <- split(stats, stats$task)

# split each dataset by predicted variable 
stats <- lapply(stats, function(dt) {
  dt <- split(dt, dt$var)
  return(dt)
})

stats <- sapply(simplify = F, names(stats), function(dataset) {
  sapply(simplify = FALSE, names(stats[[dataset]]), function(var) {
        # for each variable, dcast table 
          dt <- stats[[dataset]][[var]]
            mdt <- dcast.data.table(dt, 
                                    prefix + var + tool + data_types ~ metric, 
                                    value.var = 'value')
            if("mse" %in% colnames(mdt)) {
              mdt <- mdt[order(mse)]
            } else if ("kappa" %in% colnames(mdt)) {
              mdt <- mdt[order(kappa, decreasing = T)]
            }
      })
})

```

# Rankings 

```{r, results = 'asis'}
for (dataset in names(stats)){
  cat("## ", dataset, " {.tabset} \n\n")
  for (group in names(stats[[dataset]])) {
    cat("### ",group, "  \n\n")
    print(knitr::kable(unique(stats[[dataset]][[group]][,-1]), format = 'pipe'))
    cat("\n\n")
  }
  cat("\n\n")
}
```

